services:
  globalprotect:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        # Set USE_XVFB=1 for LXC/Proxmox compatibility (uses Xvfb + x11vnc)
        USE_XVFB: ${USE_XVFB:-0}
    image: globalprotect-docker:vnc-autofill
    hostname: globalprotect
    restart: unless-stopped
    tty: true
    shm_size: '512m'
    network_mode: host
    env_file:
      - path: .env
        required: false
    # Optional: mount config file. If not mounted, set GP_PORTAL env var instead.
    # volumes:
    #   - ./config/com.yuezk.qt/GPClient.conf:/root/.config/com.yuezk.qt/GPClient.conf
    devices:
      - /dev/net/tun
    cap_add:
      - NET_ADMIN
    labels:
      - "autoheal=true"
    healthcheck:
      test: ["CMD-SHELL", "curl -x socks5h://localhost:1080 -s -o /dev/null -w '%{http_code}' https://google.com | grep -q '^[23]'"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3

  autoheal:
    image: willfarrell/autoheal
    restart: always
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=60
      - AUTOHEAL_START_PERIOD=180
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  mtu-fixer:
    image: alpine
    network_mode: host
    container_name: mtu-fixer
    cap_add:
      - NET_ADMIN
    restart: always
    environment:
      - TARGET_MTU=1350  # Change this value here or in your .env
      - INTERFACE_NAME=tun0
    command: >
      sh -c "
      echo 'Starting MTU fixer for $$INTERFACE_NAME at $$TARGET_MTU...' ;
      while true; do
        if [ -d /sys/class/net/$$INTERFACE_NAME ]; then
          CURRENT=$$(cat /sys/class/net/$$INTERFACE_NAME/mtu) ;
          if [ \"$$CURRENT\" != \"$$TARGET_MTU\" ]; then
            ip link set dev $$INTERFACE_NAME mtu $$TARGET_MTU ;
            echo \"[$(date)] MTU adjusted from $$CURRENT to $$TARGET_MTU\" ;
          fi ;
        fi ;
        sleep 10 ;
      done"

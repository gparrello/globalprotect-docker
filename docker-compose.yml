services:
  globalprotect:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        # Set USE_XVFB=1 for LXC/Proxmox compatibility (uses Xvfb + x11vnc)
        USE_XVFB: ${USE_XVFB:-0}
    image: globalprotect-docker:vnc-autofill
    hostname: globalprotect
    restart: unless-stopped
    tty: true
    shm_size: '512m'
    network_mode: host
    env_file:
      - path: .env
        required: false
    # Optional: mount config file. If not mounted, set GP_PORTAL env var instead.
    # volumes:
    #   - ./config/com.yuezk.qt/GPClient.conf:/root/.config/com.yuezk.qt/GPClient.conf
    devices:
      - /dev/net/tun
    cap_add:
      - NET_ADMIN
    labels:
      - "autoheal=true"
    healthcheck:
      test: ["CMD-SHELL", "curl -x socks5h://localhost:1080 -s -o /dev/null -w '%{http_code}' https://google.com | grep -q '^[23]'"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3

  autoheal:
    image: willfarrell/autoheal
    restart: always
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=60
      - AUTOHEAL_START_PERIOD=180
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
